{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",

  "params": [
    {
      "name": "DriverPick",
      "value": null,
      "bind": {
        "input": "select",
        "name": "Driver: ",
        "options": [null, "Permanent agriculture", "Logging", "Shifting cultivation", "Settlements & Infrastructure", "Wildfire","Hard commodities","Other natural disturbances"],
        "labels": ["All drivers", "Permanent agriculture", "Logging", "Shifting cultivation", "Settlements & Infrastructure", "Wildfire","Hard commodities","Other natural disturbances"]
      }
    },
    {
      "name": "pYear",
      "value": 2010,
      "bind": {"input": "range", "min": 2010, "max": 2020, "step": 1, "name": "Year: ", "element": "#concat-year-controls"}
    }
  ],

  "hconcat": [
    {
      "title": {"text": "Global Deforestation Drivers Over Time (Mha)"},
      "width": 500,
      "height": 450,
      "data": {
        "url": "https://raw.githubusercontent.com/chinsn2003/FIT3179_A2/refs/heads/main/data/tree_cover_loss_by_driver.csv",
        "format": {"type": "csv"}
      },
      "transform": [
        {"calculate": "toNumber(datum.loss_area_ha)/1e6", "as": "Loss_M"},
        {"joinaggregate": [{"op": "sum", "field": "Loss_M", "as": "driver_total"}], "groupby": ["drivers_type"]},
        {"filter": "DriverPick == null || datum.drivers_type == DriverPick"}
      ],
      "mark": {"type": "area"},
      "encoding": {
        "x": {"field": "loss_year", "type": "ordinal", "sort": "ascending", "axis": {"title": "Year"}},
        "y": {"aggregate": "sum", "field": "Loss_M", "type": "quantitative", "axis": {"title": "Loss (Mha)"}},
        "color": {
          "field": "drivers_type",
          "type": "nominal",
          "title": "Driver",
          "sort": {"field": "driver_total", "op": "sum", "order": "descending"},
          "legend": {"title": "", "orient": "top-left", "labelFontSize": 10, "columns": 2},
          "scale": {"range": ["#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]}
        },
        "order": {"field": "driver_total", "type": "quantitative", "sort": "descending"},
        "tooltip": [
          {"field": "drivers_type", "title": "Driver"},
          {"field": "loss_year", "title": "Year"},
          {"aggregate": "sum", "field": "Loss_M", "title": "Loss (Mha)", "format": ".2f"}
        ]
      }
    },

    {
      "title": "Top 10 by Country â€” Tree-cover loss (Mha)",
      "width": 500,
      "height": 450,
      "data": {
        "url": "https://raw.githubusercontent.com/chinsn2003/FIT3179_A2/refs/heads/main/data/country_drivers.csv",
        "format": {"type": "csv"}
      },
      "transform": [
        {"calculate": "toNumber(datum.year)", "as": "yearN"},
        {"calculate": "toNumber(datum.tc_loss_ha)", "as": "loss"},
        {"filter": "isFinite(datum.loss) && datum.yearN == pYear"},
        {"filter": "DriverPick == null || datum.driver == DriverPick"},
        {"aggregate": [{"op": "sum", "field": "loss", "as": "loss_sum"}], "groupby": ["country"]},
        {"calculate": "abs(datum.loss_sum)", "as": "absLoss"},
        {"window": [{"op": "rank", "as": "rk"}], "sort": [{"field": "absLoss", "order": "descending"}]},
        {"filter": "datum.rk <= 10"},
        {"calculate": "datum.rk <= 2", "as": "top2"},
        {"calculate": "datum.loss_sum/1e6", "as": "loss_sum"}
      ],

      "encoding": {
        "y": {
          "field": "country",
          "type": "nominal",
          "axis": {"title": "Country", "labelLimit": 70},
  "sort": { "field": "loss_sum", "op": "max", "order": "descending" }

        },
        "x": {
          "field": "loss_sum",
          "type": "quantitative",
          "axis": {"title": "Tree-cover loss (Mha)"}
        }
      },

      "layer": [
        {
          "mark": {"type": "bar"},
          "encoding": {
            "color": {"value": "#2b7bba"},
            "opacity": {"condition": {"test": "datum.top2", "value": 1}, "value": 0.6},
            "tooltip": [
              {"field": "country", "title": "Country"},
              {"field": "loss_sum", "title": "Loss (Mha)", "format": ",.4f"}
            ]
          }
        },
        {
          "transform": [{"filter": "datum.top2"}],
          "mark": {"type": "bar", "stroke": "#000000", "strokeWidth": 2},
          "encoding": {"color": {"value": "#2b7bba"}}
        },
        {
          "transform": [{"filter": "datum.top2"}],
          "mark": {"type": "text", "align": "left", "baseline": "middle", "dx": -30, "fontSize": 11},
          "encoding": {"text": {"field": "loss_sum", "type": "quantitative", "format": ",.2f"}}
        }
      ]
    }
  ],

  "resolve": {"scale": {"color": "independent"}},

  "config": {
    "axis": {"labelFontSize": 12, "titleFontSize": 12},
    "legend": {"labelFontSize": 12, "titleFontSize": 12}
  }
}


