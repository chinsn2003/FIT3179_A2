{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Stacked bar chart per year showing Top 5 countries by tree cover loss; all others combined as 'Others'.",
  "width": 900,
  "height": 500,
  "data": {
    "url": "https://raw.githubusercontent.com/chinsn2003/FIT3179_A2/refs/heads/main/data/combined.csv",
    "format": { "type": "csv" }
  },
  "transform": [
    { "calculate": "toNumber(datum['Tree cover loss driven by all causes'])", "as": "Loss" },
    { "filter": "isValid(datum.Year) && isValid(datum['Country Name']) && isFinite(datum.Loss)" },
    {
      "aggregate": [
        { "op": "sum", "field": "Loss", "as": "LossSum" }
      ],
      "groupby": ["Year", "Country Name"]
    },
    {
      "window": [{ "op": "rank", "as": "rank" }],
      "sort": [{ "field": "LossSum", "order": "descending" }],
      "groupby": ["Year"]
    },
    { "calculate": "datum.rank <= 5 ? datum['Country Name'] : 'Others'", "as": "EntityTop" },
    { "calculate": "datum.EntityTop == 'Others' ? 1 : 0", "as": "isOthers" }
  ],
  "mark": { "type": "bar" },
  "encoding": {
    "x": {
      "field": "Year",
      "type": "ordinal",
      "sort": "ascending",
      "axis": { "title": "Year", "labelAngle": 0 }
    },
    "y": {
      "aggregate": "sum",
      "field": "LossSum",
      "type": "quantitative",
      "axis": { "title": "Tree cover loss (units from source)" }
    },
    "color": {
      "field": "EntityTop",
      "type": "nominal",
      "legend": { "title": "Country / Group" }
    },
    "order": { "field": "isOthers", "type": "quantitative", "sort": "ascending" },
    "tooltip": [
      { "field": "EntityTop", "type": "nominal", "title": "Country/Group" },
      { "field": "Year", "type": "ordinal" },
      { "aggregate": "sum", "field": "LossSum", "type": "quantitative", "title": "Tree cover loss", "format": "," }
    ]
  },
  "config": {
    "view": { "stroke": null },
    "axis": { "grid": true }
  }
}
